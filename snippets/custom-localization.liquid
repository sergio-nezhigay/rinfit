
{%- assign _show_flag  = show_country_flag | default: false -%}
{%- assign _show_name  = show_country_name | default: true -%}

{%- capture _form_id -%}loc-form-{{ id_prefix }}-{{ section.id }}-{{ type }}{%- endcapture -%}
{%- capture _panel_id -%}loc-panel-{{ id_prefix }}-{{ section.id }}-{{ type }}{%- endcapture -%}
{%- capture _toggle_id -%}loc-toggle-{{ id_prefix }}-{{ section.id }}-{{ type }}{%- endcapture -%}

<div class="cloc" data-loc-type="{{ type }}">
  {%- case type -%}
  {%- when 'country' -%}
    <div class="cloc__control">
      <button
        id="{{ _toggle_id }}"
        class="cloc__toggle"
        type="button"
        aria-haspopup="listbox"
        aria-expanded="false"
        aria-controls="{{ _panel_id }}"
      >
        <span class="cloc__label-inside">
          {{ 'general.localization.country' | t | default: 'Country' }}
        </span>
        <span class="cloc__current">
          {%- if _show_flag -%}
            {{ localization.country | image_url: width: 60, format: 'jpg' | image_tag: class: 'cloc__flag', loading: 'lazy' }}
          {%- endif -%}
          {%- if _show_name -%}
            {{ localization.country.name }} ({{ localization.country.currency.iso_code }}{% if localization.country.currency.symbol %} {{ localization.country.currency.symbol }}{% endif %})
          {%- else -%}
            {{ localization.country.currency.iso_code }}{% if localization.country.currency.symbol %} {{ localization.country.currency.symbol }}{% endif %}
          {%- endif -%}
        </span>
        <span class="cloc__chevron" aria-hidden="true">
          {%- render 'icon' with 'chevron-down' -%}
        </span>
      </button>

      <div id="{{ _panel_id }}" class="cloc__panel" role="listbox" tabindex="-1" hidden>
        {%- form 'localization', id: _form_id -%}
          <ul class="cloc__list">
            {%- for country in localization.available_countries -%}
              {%- assign selected = false -%}
              {%- if country.iso_code == localization.country.iso_code -%}
                {%- assign selected = true -%}
              {%- endif -%}
              <li class="cloc__item">
                <button
                  class="cloc__option{% if selected %} is-active{% endif %}"
                  type="submit"
                  name="country_code"
                  value="{{ country.iso_code }}"
                  role="option"
                  aria-selected="{% if selected %}true{% else %}false{% endif %}"
                >
                  {%- if _show_flag -%}
                    {{ country | image_url: width: 60, format: 'jpg' | image_tag: class: 'cloc__flag', loading: 'lazy' }}
                  {%- endif -%}
                  <span class="cloc__option-text">
                    {{ country.name }} ({{ country.currency.iso_code }}{% if country.currency.symbol %} {{ country.currency.symbol }}{% endif %})
                  </span>
                </button>
              </li>
            {%- endfor -%}
          </ul>
        {%- endform -%}
      </div>
    </div>
  {%- endcase -%}
</div>

<style>
.cloc {
  width: 100%;
  max-width: 280px;
}
@media (min-width: 992px) {
  .cloc {
    max-width: 240px;
  }
}
.cloc__control {
  position: relative;
}
.cloc__toggle {
  width: 100%;
  padding: 10px;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 0;
  background: #fff;
  border: 1px solid rgba(55, 57, 54, .2);
  border-radius: 6px;
  cursor: pointer;
  text-align: left;
  max-height: 52px;
}
.cloc__label-inside {
  font-size: 12px;
  line-height: 14px;
  color: #37393666;
  letter-spacing: .02em;
}
.cloc__current {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 14px;
  line-height: 20px;
}
.cloc__flag {
  width: 18px;
  height: 12px;
  border-radius: 2px;
  object-fit: cover;
}
.cloc__chevron {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
}
.cloc__panel {
  position: absolute;
  left: 0;
  right: 0;
  top: calc(100% + 6px);
  background: #fff;
  border: 1px solid rgba(55, 57, 54, .2);
  border-radius: 8px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, .08);
  max-height: 280px;
  overflow: auto;
  z-index: 50;
}
.cloc__list {
  list-style: none;
  margin: 0;
  padding: 6px;
}
.cloc__item + .cloc__item {
  margin-top: 4px;
}
.cloc__option {
  width: 100%;
  padding: 10px;
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
  line-height: 20px;
  text-align: left;
  background: transparent;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}
.cloc__option:hover,
.cloc__option:focus {
  background: #f3f2f1;
}
.cloc__option.is-active {
  background: #ecebea;
}

</style>

<script>
(function(){
  var section = document.getElementById('shopify-section-{{ section.id }}');
  if(!section) return;

  section.querySelectorAll('.cloc').forEach(function(root){
    var btn   = root.querySelector('.cloc__toggle');
    var panel = root.querySelector('.cloc__panel');
    if(!btn || !panel) return;

    function open(){ panel.hidden = false; btn.setAttribute('aria-expanded','true'); }
    function close(){ panel.hidden = true;  btn.setAttribute('aria-expanded','false'); }
    function toggle(){ panel.hidden ? open() : close(); }

    btn.addEventListener('click', function(e){ e.stopPropagation(); toggle(); });
    panel.addEventListener('click', function(e){ e.stopPropagation(); });

    document.addEventListener('click', function(e){
      if (!root.contains(e.target)) close();
    });
    document.addEventListener('keydown', function(e){
      if (e.key === 'Escape') close();
    });
  });
})();
</script>

